@page "/login"
@layout EmptyLayout
@using DocumentManagementSystem.Services
@using DocumentManagementSystem.Components.Layout
@inject UserService UserService
@inject AuthenticationStateService AuthService
@inject NavigationManager Nav
@rendermode InteractiveServer

<div class="login-container">
    <!-- Left Panel - Blue Background -->
    <div class="login-left-panel">
        <div class="login-branding">
            <h1 class="login-brand-name">DMS</h1>
            <p class="login-brand-subtitle">Document Management System</p>
        </div>
        <div class="login-description">
            <p>Easily manage all your companies documents.</p>
        </div>
        <div class="login-copyright">
            <p>Â© 2025 DMS. All rights reserved.</p>
        </div>
    </div>

    <!-- Right Panel - White Background -->
    <div class="login-right-panel">
        <div class="login-form-container">
            <h2 class="login-welcome">Welcome Back!</h2>

            <div class="login-form">
                <div class="mb-3">
                    <label for="username" class="form-label">User</label>
                    <input id="username" type="text" class="form-control login-input" @bind="Email"
                        @onkeypress="HandleKeyPress" />
                </div>

                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input id="password" type="password" class="form-control login-input" @bind="Password"
                        @onkeypress="HandleKeyPress" />
                </div>

                <button class="btn btn-primary login-button" @onclick="DoLogin" disabled="@IsLoading">
                    @if (IsLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        <text>Logging in...</text>
                    }
                    else
                    {
                        <text>Login Now</text>
                    }
                </button>

                @if (!string.IsNullOrEmpty(Error))
                {
                    <div class="alert alert-danger mt-3 login-error">@Error</div>
                }

            </div>
        </div>
    </div>
</div>

@code {
    private string Email = "";
    private string Password = "";
    private string Error = "";
    private bool IsLoading = false;

    private async Task DoLogin()
    {
        Error = "";
        IsLoading = true;
        StateHasChanged();

        try
        {
            // Validate inputs
            var username = Email?.Trim() ?? string.Empty;
            var password = Password ?? string.Empty;

            if (string.IsNullOrWhiteSpace(username))
            {
                Error = "Username is required.";
                IsLoading = false;
                StateHasChanged();
                return;
            }

            if (string.IsNullOrWhiteSpace(password))
            {
                Error = "Password is required.";
                IsLoading = false;
                StateHasChanged();
                return;
            }


            Console.WriteLine($"[LOGIN PAGE] Login attempt - Username: '{username}', Password length: {password.Length}");

            bool loginResult = await AuthService.LoginAsync(username, password);
            
            if (loginResult)
            {
                // Get the role from the authenticated user
                var role = AuthService.CurrentUserRole ?? "User";
                var currentUsername = AuthService.CurrentUsername ?? "";
                Console.WriteLine($"[LOGIN PAGE] Login successful - Username: {currentUsername}, Role: {role}");

                // Wait a moment to ensure state is updated
                await Task.Delay(100);
                
                // Navigate to home page
                Nav.NavigateTo("/");
            }
            else
            {
                Error = "Invalid username or password. Please check your credentials and try again.";
                Console.WriteLine("[LOGIN PAGE] Login failed - Invalid credentials");
            }
        }
        catch (Exception ex)
        {
            Error = $"An error occurred: {ex.Message}";
            Console.WriteLine($"[LOGIN PAGE] Exception: {ex.Message}");
            Console.WriteLine($"[LOGIN PAGE] Stack trace: {ex.StackTrace}");
            if (ex.InnerException != null)
            {
                Console.WriteLine($"[LOGIN PAGE] Inner exception: {ex.InnerException.Message}");
            }
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !IsLoading)
        {
            await DoLogin();
        }
    }

}