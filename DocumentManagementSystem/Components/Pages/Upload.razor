@page "/upload"
@rendermode InteractiveServer
@using DocumentManagementSystem.Services
@using DocumentManagementSystem.Model
@using Microsoft.Data.SqlClient
@inject BlobStorageService BlobStorageService
@inject OfficeService OfficeService
@inject DatabaseConnection DbConnection

<h3>Upload Document</h3>

<div class="mb-3">
    <label class="form-label">Choose Document (PDF or CSV only)</label>
    <InputFile OnChange="HandleFileUpload" />
</div>

<div class="mb-3">
    <label class="form-label">Select Office</label>
    <select class="form-select" @bind="SelectedOfficeId">
        @foreach (var office in OfficeList)
        {
            <option value="@office.OfficeID">@office.OfficeName</option>
        }
    </select>
</div>

<button class="btn btn-success" @onclick="UploadFile" disabled="@IsUploading">
    @if (IsUploading)
    {
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        <text>Uploading...</text>
    }
    else
    {
        <text>Upload</text>
    }
</button>

@if (!string.IsNullOrEmpty(Message))
{
    <div class="alert @(IsSuccess ? "alert-success" : "alert-danger") mt-3">@Message</div>
}

@if (!string.IsNullOrEmpty(BlobUrl))
{
    <div class="alert alert-info mt-3">
        <strong>File uploaded successfully!</strong><br />
    </div>
}

@code {
    private IBrowserFile? SelectedFile;
    private int SelectedOfficeId = 0;
    private string Message = "";
    private bool IsUploading = false;
    private bool IsSuccess = false;
    private string BlobUrl = "";
    private List<OfficeService.OfficeInfo> OfficeList = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await OfficeService.RefreshOfficesAsync();
            OfficeList = OfficeService.GetOffices().ToList();

            // Establecer la primera oficina como seleccionada por defecto
            if (OfficeList.Count > 0)
            {
                SelectedOfficeId = OfficeList[0].OfficeID;
            }
        }
        catch (Exception ex)
        {
            // Si falla la carga, usar las oficinas por defecto del servicio
            OfficeList = OfficeService.GetOffices().ToList();
            if (OfficeList.Count > 0)
            {
                SelectedOfficeId = OfficeList[0].OfficeID;
            }
            Message = $"Warning: Could not load offices from database. Using default list. Error: {ex.Message}";
        }
    }

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        SelectedFile = e.File;
        Message = "";
        BlobUrl = "";
        IsSuccess = false;
    }

    private async Task UploadFile()
    {
        if (SelectedFile == null)
        {
            Message = "Please select a file.";
            IsSuccess = false;
            return;
        }

        if (!(SelectedFile.ContentType == "application/pdf" ||
        SelectedFile.ContentType == "text/csv"))
        {
            Message = "Only PDF or CSV files are allowed.";
            IsSuccess = false;
            return;
        }

        IsUploading = true;
        Message = "";
        BlobUrl = "";
        IsSuccess = false;

        try
        {
            // 1. Subir archivo a Azure Blob Storage
            BlobUrl = await BlobStorageService.UploadBrowserFileAsync(SelectedFile);

            // 2. Obtener el nombre de la oficina para el mensaje
            var selectedOffice = OfficeList.FirstOrDefault(o => o.OfficeID == SelectedOfficeId);
            string officeName = selectedOffice?.OfficeName ?? "Unknown";

            // 3. Determinar el tipo de archivo
            string fileType = SelectedFile.ContentType == "application/pdf" ? "PDF" : "CSV";

            // 4. Insertar registro en la tabla Documents
            var insertSql = @"
                INSERT INTO Documents (FileName, FilePath, FileType, UploadDate, officeID) 
                VALUES (@FileName, @FilePath, @FileType, @UploadDate, @officeID)";
            
            var parameters = new[]
            {
                new SqlParameter("@FileName", SelectedFile.Name),
                new SqlParameter("@FilePath", BlobUrl),
                new SqlParameter("@FileType", fileType),
                new SqlParameter("@UploadDate", DateTime.Now),
                new SqlParameter("@officeID", SelectedOfficeId)
            };

            await DbConnection.ExecuteNonQueryAsync(insertSql, parameters);

            Message = $"File '{SelectedFile.Name}' uploaded successfully to '{officeName}' office and saved to database.";
            IsSuccess = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Message = $"Error uploading file: {ex.Message}";
            if (ex.InnerException != null)
            {
                Message += $" Inner error: {ex.InnerException.Message}";
            }
            IsSuccess = false;
            BlobUrl = "";
            StateHasChanged();
        }
        finally
        {
            IsUploading = false;
            StateHasChanged();
        }
    }
}